language: python
sudo: required
python:
  - 3.6
addons:
    postgresql: "9.5"

env:
  DOCKER_COMPOSE_VERSION: 1.11.2
  DOCKER_HOST: tcp://127.0.0.1:2375

services:
  - docker
  - redis-server
  - postgresql

before_install:
  # fix docker-compose version
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker-compose --version

  # update to Docker 1.13
  - sudo sh -c 'echo "deb https://apt.dockerproject.org/repo ubuntu-$(lsb_release -cs) main" > /etc/apt/sources.list.d/docker.list'
  - curl -fsSL https://apt.dockerproject.org/gpg | sudo apt-key add -
  - sudo apt-key fingerprint 58118E89F3A912897C070ADBF76221572C52609D
  - sudo apt-get update
  - sudo apt-get -y install "docker-engine=1.13.1-0~ubuntu-$(lsb_release -cs)"

  - nvm install node
  - npm install -g yarn bower

install:
  # db and env setup
  - psql -c 'create database backslash;' -U postgres
  - pip install virtualenv
  - python manage.py bootstrap --develop
  - python manage.py db upgrade

  # install latest backlash-python
  - .env/bin/pip install -e git://github.com/slash-testing/backslash-python.git@master#egg=backslash-python

  # build and run docker-compose setup in testing mode
  - sudo docker-compose -f docker/docker-compose.yml build
  - sudo docker-compose -f docker/docker-compose.yml -f docker/docker-compose-testing-override.yml up -d

script:
  # frontend test
  - cd webapp && yarn install && bower install && node_modules/.bin/ember test
  # build the frontend to make sure we can serve '/' in the unit tests
  - cd webapp && node_modules/.bin/ember build
  - .env/bin/py.test tests
  - .env/bin/py.test integration_tests --app-url http://127.0.0.1:8000
